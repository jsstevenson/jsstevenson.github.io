<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Customizing the IPython interface | James S. Stevenson </title> <meta name="author" content="James S. Stevenson "> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%8C%87&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://jsstevenson.github.io/blog/2022/custom-ipython-colors/"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?0afe9f0ae161375728f7bcc5eb5b4ab4"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">James S. Stevenson </span> </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/research/">research </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Customizing the IPython interface</h1> <p class="post-meta"> April 10, 2022 </p> <p class="post-tags"> <a href="/blog/2022"> <i class="fa-solid fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/category/hci"> <i class="fa-solid fa-tag fa-sm"></i> hci</a>   <a href="/blog/category/repl"> <i class="fa-solid fa-tag fa-sm"></i> repl</a>   <a href="/blog/category/python"> <i class="fa-solid fa-tag fa-sm"></i> python</a>   <a href="/blog/category/dev-tools"> <i class="fa-solid fa-tag fa-sm"></i> dev tools</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Syntax highlighting in IPython is a simple feature, but it’s a great one. The green-red back-and-forth between input and response makes scrolling back through a terminal session smooth and readable, and coloring individual tokens by semantic meaning is both informative and easy on the eyes, obviously (that’s why we do it in IDEs).</p> <p>However, if you use any kind of a custom terminal theme, this experience gets bumpier. IPython will generally lean on the basic ANSI colors set by your terminal, but (at least in my case – running zshell within Alacritty/Tmux) also summons a few colors that are definitely <em>not</em> in the specified color set, and can be pretty hard to read (bad) and ugly (obviously way worse).</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/ipython_default-480.webp 480w,/assets/img/ipython_default-800.webp 800w,/assets/img/ipython_default-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/ipython_default.png" class="img-fluid z-depth-1" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>Some of these are coming from my terminal – the light-green in the prompt, and the red traceback boundaries are correct. However, the dark green/bold, and especially the bolded blue in the traceback, are bypassing my terminal config, defined directly from IPython. And the blue, in particular, is basically unreadable against my shell background.</p> <p>There are a few out-of-the-box changes that can help, sort of. The <a href="https://ipython.readthedocs.io/en/stable/config/intro.html#setting-configurable-options" rel="external nofollow noopener" target="_blank">IPython config</a> provides a few options:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## Set the color scheme (NoColor, Neutral, Linux, or LightBG).
# c.InteractiveShell.colors = 'Neutral'
</span>
<span class="c1"># ...
</span>
<span class="c1">## The name or class of a Pygments style to use for syntax highlighting. To see
#  available styles, run `pygmentize -L styles`.
# c.TerminalInteractiveShell.highlighting_style = 'gruvbox-dark'
</span>
<span class="c1">## Override highlighting format for specific tokens
# c.TerminalInteractiveShell.highlighting_style_overrides = {}
</span></code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">InteractiveShell.colors</code> sets a general color scheme, affecting input syntax highlighting and feedback, but only offers four theme options. <code class="language-plaintext highlighter-rouge">TerminalInteractiveShell.highlighting_style</code> (and <code class="language-plaintext highlighter-rouge">TerminalInteractiveShell.highlighting_style_overrides</code>) provide many more choices by allowing the user to specify the colors that IPython provides to <a href="https://pygments.org/" rel="external nofollow noopener" target="_blank">Pygments</a> for highlightingtext, but can’t alter the colors used in feedback text (eg exception tracebacks).</p> <p>Now, the Pygments stuff is pretty great. It’s a regex-based highlighter, which means anyone used to tools like <a href="https://tree-sitter.github.io/tree-sitter/syntax-highlighting" rel="external nofollow noopener" target="_blank">Treesitter</a> will be a little disappointed, but it still affords a decent amount of granularity for color choices, and lets you define general token classes (like Number) and then provide different selections for subcomponents (like Number.Float). I couldn’t find a master list of token types used in the Python lexer, though, so I had to reconstruct an approximation from the <a href="https://github.com/pygments/pygments/blob/c155bc4e52e313a51a03f9dcafa64b92701a6829/pygments/lexers/python.py#L28" rel="external nofollow noopener" target="_blank">source code</a>:</p> <table> <thead> <tr> <th>Token</th> <th>What’s included</th> </tr> </thead> <tbody> <tr> <td><code class="language-plaintext highlighter-rouge">Text</code></td> <td>Catch-all for anything not otherwise defined</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">String</code></td> <td>Includes multiline comments, too</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">String.Escape</code></td> <td>Escape sequences within strings</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">String.Interpol</code></td> <td>The brackets in f-strings</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Number</code></td> <td>All numbers</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Number.Integer</code></td> <td>Ints</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Number.Float</code></td> <td>Floats</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Number.Bin</code></td> <td>Binary numbers</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Number.Oct</code></td> <td>Octals</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Number.Hex</code></td> <td>Hex values</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Comment</code></td> <td>Single-line comments</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Keyword</code></td> <td>Lots of members – stuff like <code class="language-plaintext highlighter-rouge">def</code>, <code class="language-plaintext highlighter-rouge">class</code>, <code class="language-plaintext highlighter-rouge">True</code> and <code class="language-plaintext highlighter-rouge">False</code>, <code class="language-plaintext highlighter-rouge">if</code>/<code class="language-plaintext highlighter-rouge">elif</code>/<code class="language-plaintext highlighter-rouge">else</code> etc.</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Keyword.Constant</code></td> <td> <code class="language-plaintext highlighter-rouge">True</code>, <code class="language-plaintext highlighter-rouge">False</code>, and <code class="language-plaintext highlighter-rouge">None</code> </td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Keyword.Reserved</code></td> <td>A few core tokens like <code class="language-plaintext highlighter-rouge">except</code>, <code class="language-plaintext highlighter-rouge">finally</code>, <code class="language-plaintext highlighter-rouge">if</code>, <code class="language-plaintext highlighter-rouge">raise</code>, <code class="language-plaintext highlighter-rouge">while</code>, etc</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Keyword.Namespace</code></td> <td> <code class="language-plaintext highlighter-rouge">import</code>, and <code class="language-plaintext highlighter-rouge">from</code>/<code class="language-plaintext highlighter-rouge">import</code> </td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Operator</code></td> <td>Everything you’d expect, and also the Walrus</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Operator.Word</code></td> <td> <code class="language-plaintext highlighter-rouge">in</code>, <code class="language-plaintext highlighter-rouge">is</code>, <code class="language-plaintext highlighter-rouge">and</code>, <code class="language-plaintext highlighter-rouge">or</code>, <code class="language-plaintext highlighter-rouge">not</code> </td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Punctuation</code></td> <td>Brackets and parens</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Name.Builtin</code></td> <td>Builtin functions like <code class="language-plaintext highlighter-rouge">all()</code>, <code class="language-plaintext highlighter-rouge">max()</code>, <code class="language-plaintext highlighter-rouge">iter()</code> </td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Name.Builtin.Pseudo</code></td> <td>Stuff like <code class="language-plaintext highlighter-rouge">self</code>, <code class="language-plaintext highlighter-rouge">Ellipsis</code>, <code class="language-plaintext highlighter-rouge">NotImplemented</code>, <code class="language-plaintext highlighter-rouge">cls</code> </td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Name.Exception</code></td> <td>All of the builtin Exception types</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Name.Function</code></td> <td>the name of the function in the definition</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Name.Function.Magic</code></td> <td>Builtin dunder methods</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Name.Variable.Magic</code></td> <td>Builtin dunder object attributes</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Name.Decorator</code></td> <td>Both the <code class="language-plaintext highlighter-rouge">@</code> and the decorator name</td> </tr> <tr> <td><code class="language-plaintext highlighter-rouge">Name.Class</code></td> <td>I think this should be the name in the class definition but couldn’t confirm experimentally</td> </tr> </tbody> </table> <p>This enables some progress:</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/ipython_progress-480.webp 480w,/assets/img/ipython_progress-800.webp 800w,/assets/img/ipython_progress-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/ipython_progress.png" class="img-fluid z-depth-1" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>But tracebacks are still a catastrophe:</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/ipython_error_fail-480.webp 480w,/assets/img/ipython_error_fail-800.webp 800w,/assets/img/ipython_error_fail-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/ipython_error_fail.png" class="img-fluid z-depth-1" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>You can use the <code class="language-plaintext highlighter-rouge">InteractiveShell</code> setting mentioned above to turn off these colors entirely (<code class="language-plaintext highlighter-rouge">nocolor</code>) or make them insane (<code class="language-plaintext highlighter-rouge">LightBG</code>). But, even though <a href="https://github.com/pygments/pygments/blob/c155bc4e52e313a51a03f9dcafa64b92701a6829/pygments/lexers/python.py#L714" rel="external nofollow noopener" target="_blank">Pygmentize does provide a lexer for tracebacks</a>, you can’t use any kind of custom colors there. So, you’re stuck.</p> <p>On another note, you can also configure the prompts, which is cool. The <a href="https://ipython.readthedocs.io/en/stable/config/details.html#custom-prompts" rel="external nofollow noopener" target="_blank">IPython config docs</a> are a bit better here than on the color scheme, although I think the <a href="https://github.com/ipython/ipython/blob/0e4d6390b2174fb1b352a082b72ad387ae696e87/IPython/terminal/prompts.py#L13" rel="external nofollow noopener" target="_blank">actual prompt file</a> is more informative than the example they point to.</p> <pre><code class="language-python3">from IPython.terminal.prompts import Prompts, Token

class MyPrompt(Prompts):
     def in_prompt_tokens(self, cli=None):
         return [(Token.Prompt, '\e[0m \033[38;2;92;28;57m \uE0B0')]

## Class used to generate Prompt token for prompt_toolkit
c.TerminalInteractiveShell.prompts_class = MyPrompt
</code></pre> <p>Powerline glyphs like the above will work, but colorization using ANSI escape codes will… unfortunately not, which is unsurprising.</p> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/ipython_prompt-480.webp 480w,/assets/img/ipython_prompt-800.webp 800w,/assets/img/ipython_prompt-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/ipython_prompt.png" class="img-fluid z-depth-1" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <p>You are at the whims of the Pygments tokens that you provide, and it’s not clear to me whether there’s any hope of overriding the token colors outside of the parent <code class="language-plaintext highlighter-rouge">InteractiveShell.colors</code> specification. Anyway, here’s to hoping that someone jumps on this stuff in a future IPython PR.</p> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 James S. Stevenson . Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Last updated: August 22, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2930004b8d7fcd0a8e00fdcfc8fc9f24"></script> <script defer src="/assets/js/common.js?4a129fbf39254905f505c7246e641eaf"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>